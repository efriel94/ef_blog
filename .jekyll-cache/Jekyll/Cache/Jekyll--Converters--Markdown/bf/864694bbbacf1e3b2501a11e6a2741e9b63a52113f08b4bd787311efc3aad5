I"&â<h1 id="introduction">Introduction</h1>

<p>This tutorial will show you how to build the latest 5.5.5 kernel on the Beaglebone Black with a root filesystem that is less than 10MB which can be easily ported to other boards and IOT devices. The tutorial will consist of using crosstool-NG to build the toolchain, using Make to build the bootloader, kernel and device trees and lastly using Buildroot to compile the root filesystem. Starting off on embedded Linux I‚Äôd recommend getting the<a href="https://www.amazon.co.uk/Mastering-Embedded-Linux-Programming-potential/dp/1787283283" target="_blank"> Mastering Embedded Linux Programming book</a> which this tutorial takes pieces of inspiration from and takes you through an in-depth description of the entire project lifecycle. Building an embedded Linux distribution from scratch requires four main elements:</p>

<ol>
  <li>Toolchain
    <ul>
      <li>A set of tools required to build and compile your source code that will be able to run on the target device. The tools include a compiler, a linker and various run-time libraries. I will be using a cross-compilation toolchain that will compile the code on my host machine (Ubuntu 18 VM) that then will run on the target (BeagleBone Black).</li>
    </ul>
  </li>
  <li>Bootloader
    <ul>
      <li>This initializes the system and loads the kernel into memory. The ability to hand off control to the kernel is achieved through device trees, a data structure (hierarchical nodes which resembles a tree) that defines the hardware.</li>
    </ul>
  </li>
  <li>Kernel
    <ul>
      <li>The heart of the operating system. It is responsible for managing resources, interfacing with hardware and it provides an API that allows users to interact with the kernel space from the user space such as shell terminal for example.</li>
    </ul>
  </li>
  <li>Root filesystem
    <ul>
      <li>The final element which provides the kernel with the required libraries and program that will be run after kernel initialization. The kernel will either mount the root filesystem in RAM, known as an initial RAM filesystem (initramfs), from the bootloader or it will mount it from a block device such as an SD card or it can be mounted over the network (NFS ‚Äì Network Filesystem).<br /><br /><br /></li>
    </ul>
  </li>
</ol>

<h1 id="1-toolchain-crosstool-ng">1. Toolchain: crosstool-NG</h1>

<p>Four major components of a toolchain:</p>

<ol>
  <li>
    <p><strong>GNU Compiler Collection (GCC)</strong> ‚Äì A collection of compilers used to convert the C/C++/Java etc. into assembly code which is then fed into the assembler.</p>
  </li>
  <li>
    <p><strong>Binary Utilities</strong> ‚Äì A set of binary utilities such as the assembler and the linker.</p>
  </li>
  <li>
    <p><strong>C Standard Library</strong> ‚Äì The C language is the gateway to the kernel which provides an API defined in POSIX.</p>
  </li>
  <li>
    <p><strong>GNU Debugger (GDB)</strong> -  Allows to peer inside the program while it is executing to fix bugs.</p>
  </li>
</ol>

<p>I will be using the Crosstool-NG to build a custom toolchain as it provides a sleek menu-driven configuration window and it allows you to see the toolchain being built from scratch as well as providing meaningful error messages. It would have been easier to use a build system such as Yocto or Buildroot as those tools encapsulate all the complexity and also generates a toolchain as part of the build though the issue with build systems is if you don‚Äôt have a basic understanding of what‚Äôs going on under the hood then prepare for a steep learning.</p>

<h2 id="dependencies">Dependencies</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>python3-dev python2.7-dev libncurses5-dev automake libsdl1.2-dev bison chrpath git  g++ gawk texinfo libtool-bin flex gperf lbexpat1-dev
</code></pre></div></div>

<h2 id="download--install">Download &amp; Install</h2>

<p>Clone the source code from crosstool-NG‚Äôs GitHub repo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents<span class="nv">$ </span>git clone https://github.com/crosstool-ng/crosstool-ng
emmet@homepc:/home/emmet/Documents<span class="nv">$ </span><span class="nb">cd </span>crosstool-ng-1.24.0/
emmet@homepc:/home/emmet/Documents/crosstool-ng-1.24.0<span class="nv">$ </span>./bootstrap
emmet@homepc:/home/emmet/Documents/crosstool-ng-1.24.0<span class="nv">$ </span>./configure <span class="nt">--enable-local</span>
emmet@homepc:/home/emmet/Documents/crosstool-ng-1.24.0<span class="nv">$ </span>make
emmet@homepc:/home/emmet/Documents/crosstool-ng-1.24.0<span class="nv">$ </span>make <span class="nb">install</span>
</code></pre></div></div>

<p>Note on some of the commands:</p>

<p><strong>Configure</strong>: Responsible for getting everything ready prior to the build such as checking dependencies and other programs that are required to build the software. It produces a custom Makefile specific to your machine from a template thats included in the tarball Makefile.in</p>

<p><strong>Make</strong>: This will run a series of tasks defined in the Makefile that will build the software from its source code.</p>

<p><strong>Make install</strong>: This will copy the built program with its libraries and documentation into the correct location.</p>

<h2 id="choosing-the-toolchain">Choosing the toolchain</h2>

<p>Crosstool-NG comes with a list of sample toolchains:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/crosstool-ng-1.24.0<span class="nv">$ </span>./ct-ng <span class="nb">help
</span>emmet@homepc:/home/emmet/Documents/crosstool-ng-1.24.0<span class="nv">$ </span>./ct-ng list-samples
Status  Sample name
<span class="o">[</span>L...]   aarch64-rpi3-linux-gnu
<span class="o">[</span>L..X]   aarch64-unknown-linux-android
<span class="o">[</span>L...]   aarch64-unknown-linux-gnu
<span class="o">[</span>L...]   aarch64-unknown-linux-uclibc
<span class="o">[</span>L...]   alphaev56-unknown-linux-gnu
<span class="o">[</span>L...]   alphaev67-unknown-linux-gnu
<span class="o">[</span>L...]   arc-arc700-linux-uclibc
<span class="o">[</span>L...]   arc-multilib-elf32
<span class="o">[</span>L...]   arc-multilib-linux-uclibc
<span class="o">[</span>L...]   arm-bare_newlib_cortex_m3_nommu-eabi
<span class="o">[</span>L...]   arm-cortex_a15-linux-gnueabihf
<span class="o">[</span>L..X]   arm-cortexa5-linux-uclibcgnueabihf
<span class="o">[</span>L...]   arm-cortex_a8-linux-gnueabi
<span class="o">[</span>L...]   armv7-rpi2-linux-gnueabihf
<span class="o">[</span>L...]   armv8-rpi3-linux-gnueabihf
<span class="o">[</span>L...]   avr
<span class="o">[</span>L...]   i586-geode-linux-uclibc
<span class="o">[</span>L...]   i686-centos6-linux-gnu
<span class="o">[</span>L...]   i686-centos7-linux-gnu
<span class="o">[</span>L...]   i686-nptl-linux-gnu
<span class="o">[</span>L...]   i686-ubuntu12.04-linux-gnu
<span class="o">[</span>L...]   i686-ubuntu14.04-linux-gnu
<span class="o">[</span>L...]   i686-ubuntu16.04-linux-gnu
<span class="o">[</span>L..X]   i686-w64-mingw32
<span class="o">[</span>L...]   m68k-unknown-elf
<span class="o">[</span>L...]   x86_64-ubuntu16.04-linux-gnu
<span class="o">[</span>L...]   x86_64-unknown-linux-gnu
<span class="o">[</span>L...]   x86_64-unknown-linux-uclibc
<span class="o">[</span>L..X]   x86_64-w64-mingw32
<span class="o">[</span>L..X]   xtensa-fsf-elf
<span class="o">[</span>L...]   xtensa-fsf-linux-uclibc
 L <span class="o">(</span>Local<span class="o">)</span>       : sample was found <span class="k">in </span>current directory
 G <span class="o">(</span>Global<span class="o">)</span>      : sample was installed with crosstool-NG
 X <span class="o">(</span>EXPERIMENTAL<span class="o">)</span>: sample may use EXPERIMENTAL features
 B <span class="o">(</span>BROKEN<span class="o">)</span>      : sample is currently broken
 O <span class="o">(</span>OBSOLETE<span class="o">)</span>    : sample needs to be upgraded
</code></pre></div></div>

<p>Select and configure the toolchain:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Downloads/crosstool-ng-1.24.0<span class="nv">$ </span>./ct-ng arm-cortex_a8-linux-gnueabi
emmet@homepc:/home/emmet/Downloads/crosstool-ng-1.24.0<span class="nv">$ </span>./ct-ng menuconfig

Paths and misc options  <span class="nt">---</span><span class="o">&gt;</span>
<span class="o">(</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span>/x-tools/<span class="k">${</span><span class="nv">CT_TARGET</span><span class="k">}</span><span class="o">)</span> Prefix directory
<span class="o">[</span> <span class="o">]</span> Render toolchain <span class="nb">read </span>only <span class="o">(</span>make sure its unchecked<span class="o">)</span>
<span class="o">(</span>4<span class="o">)</span> Number of parallel <span class="nb">jobs

</span>Target options  <span class="nt">---</span><span class="o">&gt;</span>
Floating point: <span class="o">(</span>hardware FPU<span class="o">))</span>
<span class="o">(</span>neon<span class="o">)</span> Use specific FPU
<span class="c"># The ARM Cortex-A8 has two coprocessors for floating point operations: neon and vfpv3 which can be found on the technical manual.</span>

Operating System  <span class="nt">---</span><span class="o">&gt;</span>
Version of linux <span class="o">(</span>5.5.5<span class="o">)</span>  <span class="nt">---</span><span class="o">&gt;</span> 

C-library  <span class="nt">---</span><span class="o">&gt;</span> 
<span class="o">(</span><span class="nt">--enable-obsolete-rpc</span><span class="o">)</span> extra config
<span class="c"># required to build the depreciated Sun RPC headers</span>

Save and <span class="k">then </span>Exit.
</code></pre></div></div>

<p>Check the configuration:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/crosstool-ng<span class="nv">$ </span>./ct-ng show-arm-cortex_a8-linux-gnueabi 
<span class="o">[</span>L...]   arm-cortex_a8-linux-gnueabi
    Languages       : C,C++
    OS              : linux-5.5.5
    Binutils        : binutils-2.34
    Compiler        : gcc-9.2.0
    C library       : glibc-2.31
    Debug tools     : duma-2_5_15 gdb-9.1 ltrace-0.7.3 strace-5.5
    Companion libs  : expat-2.2.9 gettext-0.20.1 gmp-6.2.0 isl-0.22 libelf-0.8.13 libiconv-1.16 mpc-1.1.0 mpfr-4.0.2 ncurses-6.2 zlib-1.2.11
    Companion tools :
</code></pre></div></div>

<p>Now the toolchain can be built. The build time will depend on your host specs but it took my Ubuntu 18 VM with 4GB RAM and 2 cores to build it in 40 minutes. Once the build is complete, you will have your sparkling new toolchain in the prefix directory you set.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/crosstool-ng-1.24.0<span class="nv">$ </span>./ct-ng build
</code></pre></div></div>

<p>Add the toolchain to your PATH and test:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents<span class="nv">$ PATH</span><span class="o">=</span>~/x-tools/arm-cortex_a8-linux-gnueabihf/bin/:<span class="nv">$PATH</span>

emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span>arm-cortex_a8-linux-gnueabihf-gcc <span class="nt">--version</span>
arm-cortex_a8-linux-gnueabihf-gcc <span class="o">(</span>crosstool-NG 1.24.0<span class="o">)</span> 8.3.0
Copyright <span class="o">(</span>C<span class="o">)</span> 2018 Free Software Foundation, Inc.
This is free software<span class="p">;</span> see the <span class="nb">source </span><span class="k">for </span>copying conditions.  There is NO
warranty<span class="p">;</span> not even <span class="k">for </span>MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</code></pre></div></div>
<p><br /><br /><br /></p>

<h1 id="2-bootloader-u-boot">2. Bootloader: U-Boot</h1>

<p>Das Universal Bootloader (shortened to U-Boot) is an open source bootloader primarily used for embedded devices to define the firmware instructions on how to boot the device‚Äôs operating system as well as supporting a wide range of architectures.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>Using a USB to TTY converter cable to communicate with the board via serial port and for debugging.</li>
  <li>Check if you have the drivers installed, if not then just do a quick search online of these dependencies and install:
    <ul>
      <li>modinfo usbserial</li>
      <li>modinfo cp210x</li>
    </ul>
  </li>
  <li>Connect pins to the serial debug on the beaglebone board:
    <ul>
      <li>USB Tx (Green)‚Üí BB Rx</li>
      <li>USB Rx (Blue) ‚Üí BB Tx</li>
      <li>USB GND (Yellow)‚Üí BB GND</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/img/embedded/bb-linux/tty-serial.png" alt="image" /></p>

<ul>
  <li>Power on the board and add the USB device filter to the virtual machine using the ‚Äú+‚Äù symbol.</li>
</ul>

<p><img src="/assets/img/embedded/bb-linux/vbox-usb.png" alt="image" /></p>

<ul>
  <li>Install picocom to communicate with the beaglebone: <code class="language-plaintext highlighter-rouge">sudo apt-get install picocom</code></li>
  <li>Connect to the beaglebone board: <code class="language-plaintext highlighter-rouge">sudo picocom -b 115200 /dev/ttyUSB0</code></li>
</ul>

<h2 id="download-and-configure-u-boot">Download and Configure U-Boot</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents<span class="nv">$ </span>git clone https://github.com/u-boot/u-boot
emmet@homepc:/home/emmet/Documents<span class="nv">$ </span><span class="nb">cd </span>u-boot
emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span>git checkout v2020.04
emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span>git checkout <span class="nt">-b</span> u-boot-bb
</code></pre></div></div>

<p>U-boot configuration is based on the Beaglebone Black‚Äôs processor i.e.AM335X Arm Cortex A8. Lots of configuration files for various boards can be found in the /configs directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span>make <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-cortex_a8-linux-gnueabihf- am335x_evm_defconfig
emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span>make menuconfig

<span class="c">#Modifications</span>
<span class="o">(</span>10<span class="o">)</span> delay <span class="k">in </span>seconds before automatically booting <span class="o">(</span>The amount of <span class="nb">time </span>we have to interrupt before its boot up<span class="o">)</span>

Command line interface  <span class="nt">---</span><span class="o">&gt;</span> <span class="o">(</span><span class="nv">emmets_uboot</span><span class="o">=&gt;</span>  <span class="o">)</span> Shell prompt

Boot media  <span class="nt">---</span><span class="o">&gt;</span> <span class="o">[</span><span class="k">*</span><span class="o">]</span> Support <span class="k">for </span>booting from SD/EMMC

<span class="c">#Disable falcon mode (CONFIG_SPL_OS_BOOT)</span>
SPL / TPL  <span class="nt">---</span><span class="o">&gt;</span> <span class="o">[</span> <span class="o">]</span> Activate Falcon Mode 
</code></pre></div></div>

<h2 id="compile-u-boot">Compile U-Boot</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span>make <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-cortex_a8-linux-gnueabihf-
</code></pre></div></div>

<p>Once the build finishes, it will generate your secondary program loader (SPL) being the MLO file and the third program loader (TPL) files being the U-boot files. SPL is required to be loaded into SRAM from either flash memory, SD card or eMMC as its used as an intermediate stager to initialize main DRAM memory and then load U-Boot since SRAM can‚Äôt run a full bootloader due to memory constraints. We will be loading MLO and U-Boot from a 8GB SD card so its necessary to partition the SD card into two sections. Partition one which will hold our boot files while partition two will hold the root filesystem. I used a tool known as GParted for partitioning.</p>

<table>
  <thead>
    <tr>
      <th>¬†</th>
      <th>Name</th>
      <th>Size</th>
      <th>Format</th>
      <th>Flags</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Partition 1</td>
      <td>boot</td>
      <td>2GB</td>
      <td>FAT32</td>
      <td>boot, LBA</td>
    </tr>
    <tr>
      <td>Partition 2</td>
      <td>rootfs</td>
      <td>6GB</td>
      <td>ext4</td>
      <td>¬†</td>
    </tr>
  </tbody>
</table>

<p>Copy SPL and TPL files onto the boot partition, unmount device and insert SD card into board. Hold down the boot button before powering on the board otherwise the Beaglebone will boot from onboard eMMC storage.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span><span class="nb">cp </span>MLO u-boot.img /media/emmet/BOOT
emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span><span class="nb">sync
</span>emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span><span class="nb">sudo </span>umount /media/emmet/BOOT 
emmet@homepc:/home/emmet/Documents/u-boot<span class="nv">$ </span><span class="nb">sudo </span>umount /media/emmet/root
emmet@homepc:~<span class="nv">$ </span><span class="nb">sudo </span>picocom <span class="nt">-b</span> 115200 /dev/ttyUSB0 

U-Boot SPL 2020.04 <span class="o">(</span>Jun 15 2020 - 15:29:01 +0100<span class="o">)</span>
Trying to boot from MMC1


U-Boot 2020.04 <span class="o">(</span>Jun 15 2020 - 15:29:01 +0100<span class="o">)</span>

CPU  : AM335X-GP rev 2.1
Model: TI AM335x BeagleBone Black
DRAM:  512 MiB
WDT:   Started with servicing <span class="o">(</span>60s <span class="nb">timeout</span><span class="o">)</span>
NAND:  0 MiB
MMC:   OMAP SD/MMC: 0, OMAP SD/MMC: 1
Loading Environment from FAT... <span class="k">***</span> Warning - bad CRC, using default environment

&lt;ethaddr&gt; not set. Validating first E-fuse MAC
Net:   eth0: ethernet@4a100000
Warning: usb_ether MAC addresses dont match:
Address <span class="k">in </span>ROM is          de:ad:be:ef:00:01
Address <span class="k">in </span>environment is  0c:ae:7d:0c:4f:f4
 , eth1: usb_ether
Hit any key to stop autoboot:  0 
<span class="nv">emmets_uboot</span><span class="o">=&gt;</span>  
</code></pre></div></div>
<p><br /><br /><br /></p>

<h1 id="3-linux-kernel">3. Linux Kernel</h1>

<p>The Linux kernel is the core component of the operating system that is responsible for providing an interface to the user space via the C library, interfacing with the hardware using device drivers and lastly, managing resources such as memory, storage and the execution of tasks.</p>

<p><img src="/assets/img/embedded/bb-linux/kernel.png" alt="image" /></p>

<h2 id="download-the-source-code">Download the source code</h2>
<p>The Linux Kernel main branch is managed by its creator, Linus Torvalds and you can download the source code from GitHub:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents<span class="nv">$ </span>git clone https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/
emmet@homepc:/home/emmet/Documents<span class="nv">$ </span><span class="nb">cd </span>linux/
emmet@homepc:/home/emmet/Documents/linux<span class="nv">$ </span>git checkout v5.5.5
emmet@homepc:/home/emmet/Documents/linux<span class="nv">$ </span>git checkout <span class="nt">-b</span> kernel-bb-5.5.5 <span class="c"># creates a local branch</span>
</code></pre></div></div>

<p>You can find all the different kernel configuration files based on the architecture in <code class="language-plaintext highlighter-rouge">linux/arch/&lt;architecture&gt;/configs</code>. The Beaglebone Black is based on the ARM V7 architecture so the configuration we are going to use is: <strong>multi_v7_defconfig</strong>. Clean the project before starting:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/linux<span class="nv">$ </span>make distclean
</code></pre></div></div>

<h2 id="configure-and-build-the-kernel">Configure and Build the kernel</h2>
<p>Select the ARM V7 kernel configuration file and launch the menuconfig window. In the case of building the kernel, the architecture has to be expressed in addition to CROSS_COMPILE and the various types of architectures that can be supplied can be seen in the <code class="language-plaintext highlighter-rouge">arch</code> directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/linux<span class="nv">$ </span>make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-cortex_a8-linux-gnueabihf- multi_v7_defconfig
emmet@homepc:/home/emmet/Documents/linux<span class="nv">$ </span>make <span class="nv">ARCH</span><span class="o">=</span>arm menuconfig

<span class="c">#Modifications</span>
General setup  <span class="nt">---</span><span class="o">&gt;</span> <span class="o">(</span><span class="nt">-emmetfriel</span><span class="o">)</span> Local version - append to kernel release 
General setup  <span class="nt">---</span><span class="o">&gt;</span> <span class="o">((</span>beaglebone-ef<span class="o">))</span> Default <span class="nb">hostname</span>
</code></pre></div></div>

<p>Build and compile the kernel:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/linux<span class="nv">$ </span>make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-cortex_a8-linux-gnueabihf- 
</code></pre></div></div>

<p>Check your new kernel release:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/linux<span class="nv">$ </span>make kernelrelease
5.5.5-emmetfriel
</code></pre></div></div>

<p>The output files are in the <code class="language-plaintext highlighter-rouge">arch/arm/boot/</code> directory. Copy the kernel image (zImage) and the device tree blob <code class="language-plaintext highlighter-rouge">arch/arm/boot/dts/am335x-boneblack.dtb</code> onto the boot partition of the SD card.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/linux/arch/arm/boot<span class="nv">$ </span><span class="nb">cp </span>zImage /media/emmet/BOOT
emmet@homepc:/home/emmet/Documents/linux/arch/arm/boot<span class="nv">$ </span><span class="nb">cp </span>dts/am335x-boneblack.dtb /media/emmet/BOOT
emmet@homepc:/home/emmet/Documents/linux/arch/arm/boot<span class="nv">$ </span><span class="nb">sync</span> 
</code></pre></div></div>

<h2 id="predefining-boot-parameters-using-uenvtxt">Predefining boot parameters using uEnv.txt</h2>

<p>U-Boot supports using uEnv.txt which is a text file that declares and initializes boot variables before U-Boot runs bootcmd. Create a file uEnv.txt, insert the contents below and copy it onto the boot partition:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">console</span><span class="o">=</span>ttyS0,115200  
<span class="nv">ethaddr</span><span class="o">=</span>02:f8:7e:a6:fc:e1
<span class="nv">ipaddr</span><span class="o">=</span>192.168.1.1
<span class="nv">serverip</span><span class="o">=</span>192.168.1.10
<span class="nv">bootfile</span><span class="o">=</span>zImage
<span class="nv">fdtfile</span><span class="o">=</span>am335x-boneblack.dtb
<span class="nv">loadaddr</span><span class="o">=</span>0x80007fc0
<span class="nv">fdtaddr</span><span class="o">=</span>0x80F80000
<span class="nv">loadfdt</span><span class="o">=</span>fatload mmc 0:1 <span class="k">${</span><span class="nv">fdtaddr</span><span class="k">}</span> <span class="k">${</span><span class="nv">fdtfile</span><span class="k">}</span>
<span class="nv">loaduimage</span><span class="o">=</span>fatload mmc 0:1 <span class="k">${</span><span class="nv">loadaddr</span><span class="k">}</span> <span class="k">${</span><span class="nv">bootfile</span><span class="k">}</span>
<span class="nv">mmc_args</span><span class="o">=</span>setenv bootargs <span class="nv">console</span><span class="o">=</span><span class="k">${</span><span class="nv">console</span><span class="k">}</span> <span class="k">${</span><span class="nv">optargs</span><span class="k">}</span> <span class="nv">root</span><span class="o">=</span>/dev/mmcblk0p2 <span class="nv">rootfstype</span><span class="o">=</span>ext4
<span class="nv">fdtboot</span><span class="o">=</span>run mmc_args<span class="p">;</span> bootz <span class="k">${</span><span class="nv">loadaddr</span><span class="k">}</span> - <span class="k">${</span><span class="nv">fdtaddr</span><span class="k">}</span>
<span class="nv">uenvcmd</span><span class="o">=</span>mmc rescan<span class="p">;</span> run loaduimage<span class="p">;</span> run loadfdt<span class="p">;</span> run fdtboot<span class="p">;</span>
</code></pre></div></div>

<p>Insert SD card back into the beaglebone and test the kernel:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>    2.348290] EXT4-fs <span class="o">(</span>mmcblk0p2<span class="o">)</span>: mounted filesystem with ordered data mode. Opts: <span class="o">(</span>null<span class="o">)</span>
<span class="o">[</span>    2.356659] VFS: Mounted root <span class="o">(</span>ext4 filesystem<span class="o">)</span> <span class="nb">readonly </span>on device 179:2.
<span class="o">[</span>    2.364781] devtmpfs: error mounting <span class="nt">-2</span>
<span class="o">[</span>    2.370319] Freeing unused kernel memory: 1024K
<span class="o">[</span>    2.375558] Run /sbin/init as init process
<span class="o">[</span>    2.379760] Run /etc/init as init process
<span class="o">[</span>    2.383803] Run /bin/init as init process
<span class="o">[</span>    2.387893] Run /bin/sh as init process
<span class="o">[</span>    2.391757] Kernel panic - not syncing: No working init found.  Try passing <span class="nv">init</span><span class="o">=</span> option to kernel. See Linux Documentation/admin-guide/init.rst <span class="k">for </span>guidance.
<span class="o">[</span>    2.405995] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 5.5.5-emmetfriel <span class="c">#1</span>
<span class="o">[</span>    2.412809] Hardware name: Generic AM33XX <span class="o">(</span>Flattened Device Tree<span class="o">)</span>
<span class="o">[</span>    2.418969] <span class="o">[</span>&lt;c03124e0&gt;] <span class="o">(</span>unwind_backtrace<span class="o">)</span> from <span class="o">[</span>&lt;c030c6dc&gt;] <span class="o">(</span>show_stack+0x10/0x14<span class="o">)</span>
<span class="o">[</span>    2.426758] <span class="o">[</span>&lt;c030c6dc&gt;] <span class="o">(</span>show_stack<span class="o">)</span> from <span class="o">[</span>&lt;c0daa3e8&gt;] <span class="o">(</span>dump_stack+0xbc/0xd0<span class="o">)</span>
<span class="o">[</span>    2.434027] <span class="o">[</span>&lt;c0daa3e8&gt;] <span class="o">(</span>dump_stack<span class="o">)</span> from <span class="o">[</span>&lt;c0338e60&gt;] <span class="o">(</span>panic+0x110/0x328<span class="o">)</span>
<span class="o">[</span>    2.441026] <span class="o">[</span>&lt;c0338e60&gt;] <span class="o">(</span>panic<span class="o">)</span> from <span class="o">[</span>&lt;c0dc1f50&gt;] <span class="o">(</span>kernel_init+0x108/0x110<span class="o">)</span>
<span class="o">[</span>    2.448109] <span class="o">[</span>&lt;c0dc1f50&gt;] <span class="o">(</span>kernel_init<span class="o">)</span> from <span class="o">[</span>&lt;c03010e8&gt;] <span class="o">(</span>ret_from_fork+0x14/0x2c<span class="o">)</span>
<span class="o">[</span>    2.455709] Exception stack<span class="o">(</span>0xdb0b1fb0 to 0xdb0b1ff8<span class="o">)</span>
<span class="o">[</span>    2.460782] 1fa0:                                     00000000 00000000 00000000 00000000
<span class="o">[</span>    2.468997] 1fc0: 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
<span class="o">[</span>    2.477208] 1fe0: 00000000 00000000 00000000 00000000 00000013 00000000
<span class="o">[</span>    2.483868] <span class="nt">---</span><span class="o">[</span> end Kernel panic - not syncing: No working init found.  Try passing <span class="nv">init</span><span class="o">=</span> option to kernel. See Linux Documentation/admin-guide/init.rst <span class="k">for </span>guidance. <span class="o">]</span><span class="nt">---</span>
</code></pre></div></div>

<p>The kernel should hang or panic which is expected as there is no root filesystem on the SD card. The root filesystem will now be built using Buildroot.
<br /><br /><br /></p>

<h1 id="4-root-filesystem-buildroot">4. Root Filesystem: Buildroot</h1>

<p>Buildroot is an embedded Linux build system that supports many processors and architectures with the ability to generate a toolchain, root filesystem, Linux kernel and a bootloader. Since we have built our own toolchain, bootloader and kernel, Buildroot will be used to a create a minimal root filesystem that will include busybox and simple packages.</p>

<h2 id="clone-and-configure-buildroot">Clone and Configure Buildroot</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone git://git.buildroot.net/buildroot
make beaglebone_defconfig
make menuconfig
</code></pre></div></div>
<p>Modifications:</p>
<ol>
  <li>Configure buildroot to use our own toolchain instead of the built-in toolchain
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Toolchain  <span class="nt">---</span><span class="o">&gt;</span> Toolchain <span class="o">(</span>Custom toolchain<span class="o">)</span>  <span class="nt">---</span><span class="o">&gt;</span> 
      <span class="o">(</span>/home/emmet/x-tools/arm-cortex_a8-linux-gnueabihf<span class="o">)</span> Toolchain path
     External toolchain gcc version <span class="o">(</span>9.x<span class="o">)</span>  <span class="nt">--</span>‚Üí
     External toolchain kernel headers series <span class="o">(</span>5.5.x<span class="o">)</span>  <span class="nt">---</span><span class="o">&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>Personalizing the OS
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>System configuration  <span class="nt">---</span><span class="o">&gt;</span>     <span class="o">(</span>buildroot-ef<span class="o">)</span> System <span class="nb">hostname</span>
             <span class="o">(</span>Welcome to Emmets Buildroot<span class="o">)</span> System banner
             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Enable root login with password
             <span class="o">(</span>password123<span class="o">)</span> Root password
</code></pre></div>    </div>
  </li>
  <li>Disable kernel since we built our own
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Kernel  <span class="nt">---</span><span class="o">&gt;</span> <span class="o">[</span> <span class="o">]</span> Linux Kernel
</code></pre></div>    </div>
  </li>
  <li>Enable several packages
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Networking applications  <span class="nt">---</span><span class="o">&gt;</span>	<span class="o">[</span><span class="k">*</span><span class="o">]</span> dhcpcd
                             <span class="o">[</span><span class="k">*</span><span class="o">]</span> openssh
Text editors and viewers  <span class="nt">---</span><span class="o">&gt;</span> 	<span class="o">[</span><span class="k">*</span><span class="o">]</span> nano
                             <span class="o">[</span><span class="k">*</span><span class="o">]</span>   optimize <span class="k">for </span>size
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="build-the-root-filesystem">Build the root filesystem</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/buildroot<span class="nv">$ </span>make
</code></pre></div></div>

<p><strong>Error</strong>: If the build throws up an error then copy the relevant files illustrated in the error message into <code class="language-plaintext highlighter-rouge">buildroot/output/images/</code> directory. If the directory doesn‚Äôt exist then create it. The build files will be in the <code class="language-plaintext highlighter-rouge">output/images/</code> directory so the next stage is to flash partition 2 of the SD card with the root filesystem. Check where your block device resides before flashing as you may destroy your disk:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>emmet@homepc:/home/emmet/Documents/buildroot<span class="nv">$ </span><span class="nb">sudo </span>fdisk <span class="nt">-l</span>
Device     Boot   Start      End  Sectors  Size Id Type
/dev/sdb1  <span class="k">*</span>       2048  2086911  2084864 1018M  c W95 FAT32 <span class="o">(</span>LBA<span class="o">)</span>
/dev/sdb2       2086912 15564799 13477888  6.4G 83 Linux

emmet@homepc:/home/emmet/Documents/buildroot<span class="nv">$ </span><span class="nb">sudo dd </span><span class="k">if</span><span class="o">=</span>output/images/rootfs.ext4 <span class="nv">of</span><span class="o">=</span>/dev/sdb2
</code></pre></div></div>
<p><br /><br /><br /></p>

<h1 id="booting-up-the-custom-linux-os">Booting up the custom Linux OS</h1>

<p>Unmount, eject and place the SD card into the Beaglebone Black. The serial console will now show the operating system booting up a lightweight custom embedded Linux distribution.</p>

<p><img src="/assets/img/embedded/bb-linux/buildroot.png" alt="image" /></p>

:ET